<html>
	<head>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

		<title>Scrobble Online</title>
		<meta name="keywords" content="last.fm, scrobble, music, data, data tracking">
		<!-- <link rel="stylesheet" href="style.css"> -->
		<!-- <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic' rel='stylesheet' type='text/css'>
		<link href='https://fonts.googleapis.com/css?family=Arimo:400,400italic' rel='stylesheet' type='text/css'>
 -->
		<script type="text/Javascript">

			$(function () {
				var query = window.location;
				query = query.substring(query.indexOf("=") + 1);
				var returned_data = {};
				if (query.length() != 0 ) {
					window.alert("congrats!");
					var signature = md5("api_key7b42da46777d0daaca78ca34ee93fa1dmethodauth.getSessiontoken" + query);
					//fetch a web service session
					$.ajax({
						type: "GET",
						url: 'http://ws.audioscrobbler.com/2.0/?method=auth.getSession&api_key=7b42da46777d0daaca78ca34ee93fa1d&token=' + query + "&api_sig=" + signature,
						data: returned_data,
						cache: false,
						success: function(data){
							xmlDoc = $.parseXML( data ),
							$xml = $(xmlDoc),
							$name = $xml.find("name");
							$("#loginStatus").html($name.text());
							var sessionKey = $xml.find("key").text();
							PageReadyToUse();
						}
					});
				}
			}

			function PageReadyToUse() {
				document.getElementById("#scrobbleButton").prop("disabled", false);
			}


			var userPassError = "Please enter a username and password";

			$()

			function manualScrobble() {
				artist = document.getElementById("Artist").value;
				track = document.getElementById("Track").value;
				album = document.getElementById("Album").value;
				scrobbleTime = Math.floor(Date.now() / 1000);
				scrobbleTrack(artist, album, track, 0, scrobbleTime);
			}

			//this will eventually be called by multiple things so I'm splitting it up

			function scrobbleTrack(artist, album, track, trackNum, timeOfScrobble, duration) {

				// the only important ones are artist and track, last.fm can do the rest i belive

				album =  album || null;
				trackNum = trackNum || null;
				duration = duration || 200;
				params = "";
				window.alert("scrobbling " + track + " on " + album + " by " + artist );

			// make sure user and pw are entered
				if ((!(document.getElementById("Password").value)) || (!document.getElementById("Username").value)) {
					window.alert(userPassError);
					return false // this stops the whole function. very useful.
				}

				//encodeURIComponent fixes weird characters and makes them html friendly
				// eg  : -> %3A

				params = "submissionType=Track";
				// this bit feels insecure but its how uniscrobbler does it.
				// params += "&username=" + encodeURIComponent(document.getElementById('Username').value);
				// params += "&password=" + encodeURIComponent(document.getElementById('Password').value);
				params += "&artist=" + encodeURIComponent(artist);
				params += "&track=" + encodeURIComponent(track);
				params += "&album=" + encodeURIComponent(album);

				if (duration != 0) { //future proofing 8-D
					params += "&duration=" + duration;
					params += "&time=" + (scrobbleTime - duration);

				} else {
					params += "&time=" + scrobbleTime;
				}

				window.alert(params);

				jquery.$.post('http://ws.audioscrobbler.com/2.0/?method=track.scrobble&' + params, "",
					function (data) {
						if (data.success == 1) {
							window.alert("scrobbled!");
						} else {
							window.alert("failed scrobbling: " + info.message);
						}
					}
				);
			}
		</script>


	</head>
	<body>
		<div id="header">
		<span style="font-size:20;"> You need to <a href="http://www.last.fm/api/auth/?api_key=7b42da46777d0daaca78ca34ee93fa1d">log in</a> before you can scrobble!</span>
		<br>
		<span>Currently <span id="loginStatus">not logged in</span>.</span>

		</div>
		<div id="credentials">
			<br>
			<input type="text" placeholder="Last.fm Username" id="Username"> <input type="password" placeholder="Password" id="Password">
		</div>
		<div id="song">
			<br>
			<input type="text" placeholder="Artist" id="Artist">
			<input type="text" placeholder="Album Artist (optional)" id="AlbumArtist">
			<br>
			<input type="text" placeholder="Track Name" id="Track">
			<input type="text" placeholder="Album" id="Album">
			<br>
			<button onclick="manualScrobble()" id= "scrobbleButton" type='button' disabled="disabled">test</button>
		</body>